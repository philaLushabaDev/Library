<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Reports — Lunyati Library</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
   body{font-family:Arial, sans-serif;background:#f5f9f6;margin:0;color:#222}
    header {
      background: #2d6a4f;
      color: #fff;
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { margin: 0; font-size: 22px; }
    .header-right { display: flex; align-items: center; }
    header a.logout-btn {
      background: #d90429;
      color: #fff;
      padding: 8px 14px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 700;
      margin-right: 20px;
    }
    /*#welcome-message { margin-right: 20px; }*/
    .header-right { display: flex; align-items: center; }
    a.logout-btn { background: #d90429; color: #fff; padding: 8px 14px; border-radius: 4px; text-decoration: none; font-weight: 700; margin-right: 20px; }
    nav { background-color: #2d6a4f; padding: 10px 0; display: flex; align-items: center;}
    nav a { margin-right: 20px; text-decoration: none; color: #fff; }
    nav a:hover { text-decoration: underline; }
    .card { background: #fff; padding: 14px; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); margin-bottom: 12px; }
    .cards { display: flex; gap: 12px; flex-wrap: wrap; }
    .big { font-size: 28px; font-weight: 700; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { padding: 10px; border: 1px solid #eee; text-align: left; }
    thead th { background: #2d6a4f; color: #fff; }
    a.btn { display: inline-block; padding: 8px 12px; border-radius: 6px; background: #0077b6; color: #fff; text-decoration: none; margin-top: 10px; }
    .task-btn { background: #2d6a4f; }
    .task-btn:hover { background: #3b8a5a; }
    /* popup position */
.flash-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) translateY(-10px); /* center + animation */
  z-index: 1050;
  padding: 16px 24px;
  border-radius: 8px;
  color: #fff;
  background: #333;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);

  opacity: 0;
  transition: opacity 0.4s ease, transform 0.4s ease;
}
.flash-popup.show {
  opacity: 1;
  transform: translate(-50%, -50%) translateY(0);
}

/* bootstrap category colors (optional override) */
.alert-success { background: #28a745; }
.alert-danger { background: #dc3545; }
.alert-warning { background: #ffc107; color:#333; }
.alert-info { background: #17a2b8; }

/* when visible */
.flash-popup.show {
  opacity: 1;
  transform: translateY(0);
}
  </style>
</head>
<body>


  <div class="messages">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} flash-popup">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} flash-popup">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

<style>

</style>



<header><h1>Lunyati Library - Reports</h1>
  <div class="header-right">
    <section>
  <a href="{{ url_for('generate_report') }}" class="btn task-btn">Generate New Report</a>
 <a href="{{ url_for('export_report') }}" class="btn task-btn">Export Excel Report</a>
  <a href="{{ url_for('view_statistics') }}" class="btn task-btn">View Statistics</a>
  <a class="btn task-btn" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
    
  </section>
  </div>
</header>

<nav>
  <a href="{{ url_for('view_members') }}">Manage Members</a>
  <a href="{{ url_for('daily_planner') }}">Daily Planner</a>
</nav>

<section class="cards" aria-label="summary">
  
  <div class="card"><div class="big">{{ report.total_books }}</div><div>Total books</div></div>
  <div class="card"><div class="big">{{ report.rented_books }}</div><div>Rented books</div></div>
  <div class="card"><div class="big">{{ report.checked_out_count }}</div><div>Checked Out Books</div></div>
  <div class="card"><div class="big">{{ report.overdue_books }}</div><div>Overdue books</div></div>
  <div class="card"><div class="big">{{ report.total_members }}</div><div>Total members</div></div>
  <div class="card"><div class="big">{{ report.suspended_members }}</div><div>Suspended members</div></div>


</section>

<section>
  <h2>Overdue details</h2>
  {% if report.overdue_list and report.overdue_list|length > 0 %}
  <table>
    <thead>
      <tr>
        <th>Book ID</th>
        <th>Title</th>
        <th>Borrower</th>
        <th>Due Date</th>
        <th>Due Amount (SZL)</th>
      </tr>
    </thead>
    <tbody>
      {% for r in report.overdue_list %}
        <tr>
          <td>{{ r.book_id }}</td>
          <td>{{ r.title }}</td>
          <td>{{ r.borrower_name or '—' }}</td>
          <td>{{ r.due_date }}</td>
          <td>E{{ "%.2f"|format(r.due_amount or 0) }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No overdue books right now.</p>
  {% endif %}
</section>

<section>
  <h2>Members by Age Ranges</h2>
  {% if report.age_ranges and report.age_ranges|length > 0 %}
  <table>
    <thead>
      <tr><th>Age Range</th><th>Count</th></tr>
    </thead>
    <tbody>
      {% for ar in report.age_ranges %}
        <tr>
          <td>{{ ar.age_group }}</td>
          <td>{{ ar.cnt }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No members found in any age range.</p>
  {% endif %}
</section>

<section>
  <h3>Books Checked Out</h3>
  {% if report.checked_out_books and report.checked_out_books|length > 0 %}
  <table>
    <thead>
      <tr>
        <th>Book ID</th>
        <th>Title</th>
        <th>Borrower</th>
        <th>Due Date</th>
      </tr>
    </thead>
    <tbody>
      {% for book in report.checked_out_books %}
        <tr>
          <td>{{ book.book_id }}</td>
          <td>{{ book.title }}</td>
          <td>{{ book.borrower_name or '—' }}</td>
          <td>{{ book.due_date }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No books currently checked out.</p>
  {% endif %}
</section>



<script>
document.addEventListener("DOMContentLoaded", () => {
  const alerts = document.querySelectorAll(".flash-popup");
  alerts.forEach((alert) => {
    setTimeout(() => alert.classList.add("show"), 100);
    setTimeout(() => {
      alert.classList.remove("show");
      setTimeout(() => alert.remove(), 400);
    }, 3000);
  });

   // Handle export button
  const exportBtn = document.querySelector('a[href$="export_report"]');
  if (exportBtn) {
    exportBtn.addEventListener("click", (e) => {
      e.preventDefault();
      fetch(exportBtn.href)
        .then(response => response.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "library_report.xlsx";
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.location.href = "{{ url_for('reports_page') }}?exported=1"; // reload after download
        });
    });
  }
});
</script>

</body>
</html>
