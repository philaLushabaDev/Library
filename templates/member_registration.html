<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Member Registration -- Lunyati Library</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f9f6; margin: 0; color: #222; }
    .container { max-width: 900px; margin: 28px auto; background: #fff; padding: 18px 20px; border-radius: 8px; box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06); }
    header {
      background: #2d6a4f; color: #fff; padding: 14px 24px; display: flex; justify-content: space-between; align-items: center;
    }
    header h1 { margin: 0; font-size: 22px; }
    #welcome-message { margin-right: 20px; }
    .muted { color: #666; font-size: 13px; margin-bottom: 8px; }
    form .row { display: flex; gap: 12px; margin-bottom: 10px; }
    .col { flex: 1; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input[type="text"], input[type="email"], input[type="number"], input[type="date"], textarea, select {
      width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box;
    }
    .btn { padding: 8px 12px; border-radius: 6px; border: none; background: #2d6a4f; color: #fff; cursor: pointer; font-weight: 700; display: inline-block; }
    textarea { resize: vertical; min-height: 80px; }
    .actions { text-align: right; margin-top: 12px; }
    button { background: #2d6a4f; color: #fff; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 700; }
    button.secondary { background: #fff; color: #2d6a4f; border: 2px solid #2d6a4f; margin-right: 8px; }
    .result-message { margin-bottom: 12px; padding: 10px; border-radius: 4px; display: none; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .loading-message { color: #0077b6; font-weight: bold; margin-top: 10px; display: none; }
    .back-button { margin-top: 20px; display: inline-block; background: #e2e3e5; color: #6c757d; padding: 10px 14px; border-radius: 8px; text-decoration: none; }
    .popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 1000; }
    .popup-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999; }
  </style>
</head>
<body>

<header>
  <h1>Lunyati Library - Member Registration</h1>
</header>

<div class="container">
  <h1>Member Registration</h1>
  <p class="muted">Fill in the details below and click "Register member". Fields marked * are required.</p>

  <div id="reg-result" class="result-message" aria-live="polite"></div>
  <div id="loading-message" class="loading-message">Please wait, registering member...</div>

  <form id="member-reg-form">
    <label for="gender">Gender *</label>
    <select id="gender" name="gender" required>
      <option value="">Select gender</option>
      <option value="Male">M</option>
      <option value="Female">F</option>
      <option value="Other">Other</option>
    </select>

    <label for="full_name">Full name *</label>
    <input id="full_name" name="full_name" type="text" required>

    <div class="row">
      <div class="col">
        <label for="email">Email</label>
        <input id="email" name="email" type="email">
      </div>
      <div class="col">
        <label for="phone">Phone</label>
        <input id="phone" name="phone" type="text" placeholder="+268...">
      </div>
    </div>

    <label for="physical_address">Physical address</label>
    <input id="physical_address" name="physical_address" type="text">

    <label for="postal_address">Postal address</label>
    <input id="postal_address" name="postal_address" type="text">

    <div class="row">
      <div class="col">
        <label for="join_date">Join date</label>
        <input id="join_date" name="join_date" type="date">
      </div>
      <div class="col">
        <label for="status">Status *</label>
        <select id="status" name="status" required>
          <option value="active">active</option>
          <option value="suspended">suspended</option>
          <option value="inactive">inactive</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="age">Age *</label>
        <input id="age" name="age" type="number" min="0" required>
      </div>
      <div class="col">
        <label for="age_group">Age Group</label>
        <select id="age_group" name="age_group">
          <option value="">Select age group</option>
          <option value="0-12">0-12</option>
          <option value="13-17">13-17</option>
          <option value="18-25">18-25</option>
          <option value="26-35">26-35</option>
          <option value="36-50">36-50</option>
          <option value="51+">51+</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="outstanding_fees">Outstanding fees</label>
        <input id="outstanding_fees" name="outstanding_fees" type="number" step="0.01" min="0" value="0.00">
      </div>
      <div class="col">
        <label for="next_of_kin">Next of kin</label>
        <input id="next_of_kin" name="next_of_kin" type="text">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="next_of_kin_contact">Next of kin contact</label>
        <input id="next_of_kin_contact" name="next_of_kin_contact" type="text">
      </div>
      <div class="col">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes"></textarea>
      </div>
    </div>

    <div class="actions">
      <button type="button" class="secondary" id="btn-cancel">Cancel</button>
      <button type="submit">Register member</button>
    </div>
  </form>

  <a href="{{ url_for('dashboard') }}" class="btn" style="background:#0077b6;">Back to Dashboard</a>
</div>

<!-- Popup for registration confirmation -->
<div class="popup-overlay" id="popup-overlay"></div>
<div class="popup" id="popup">
  <p id="popup-message"></p>
  <button id="popup-ok" class="btn">OK</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Default join_date -> today
  const joinDate = document.getElementById('join_date');
  if (joinDate && !joinDate.value) joinDate.value = new Date().toISOString().slice(0, 10);

  document.getElementById('btn-cancel').addEventListener('click', () => {
    window.history.back();
  });

  document.getElementById('member-reg-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const result = document.getElementById('reg-result');
    const loadingMessage = document.getElementById('loading-message');
    const popup = document.getElementById('popup');
    const popupMessage = document.getElementById('popup-message');
    const popupOverlay = document.getElementById('popup-overlay');

    result.textContent = ''; 
    result.className = '';
    loadingMessage.style.display = 'block'; // Show loading message

    const payload = {
      gender: document.getElementById('gender').value || null,
      full_name: document.getElementById('full_name').value.trim(),
      email: document.getElementById('email').value.trim() || null,
      phone: document.getElementById('phone').value.trim() || null,
      physical_address: document.getElementById('physical_address').value.trim() || null,
      postal_address: document.getElementById('postal_address').value.trim() || null,
      join_date: document.getElementById('join_date').value || null,
      status: document.getElementById('status').value || 'active',
      age: parseInt(document.getElementById('age').value || 0),
      age_group: document.getElementById('age_group').value || null,
      outstanding_fees: parseFloat(document.getElementById('outstanding_fees').value || 0),
      notes: document.getElementById('notes').value.trim() || null,
      next_of_kin: document.getElementById('next_of_kin').value.trim() || null,
      next_of_kin_contact: document.getElementById('next_of_kin_contact').value.trim() || null
    };

    if (!payload.full_name) {
      result.textContent = 'Full name is required!!';
      result.className = 'error';
      loadingMessage.style.display = 'none'; // Hide loading message
      return;
    }

    try {
      const res = await fetch('/members/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (j && j.ok) {
        popupMessage.textContent = `Member registered: ${j.member_id}`;
        popup.style.display = 'block'; // Show popup
        popupOverlay.style.display = 'block'; // Show overlay
      } else {
        result.textContent = (j && j.msg) ? j.msg : 'Failed to register member.';
        result.className = 'error';
      }
      result.style.display = 'block';
    } catch (err) {
      console.error(err);
      result.textContent = 'Network error -- could not register member.';
      result.className = 'error';
      result.style.display = 'block';
    } finally {
      loadingMessage.style.display = 'none'; // Hide loading message
    }
  });

  // Close popup on OK button click
  document.getElementById('popup-ok').addEventListener('click', () => {
    document.getElementById('popup').style.display = 'none'; // Hide popup
    document.getElementById('popup-overlay').style.display = 'none'; // Hide overlay
    document.getElementById('member-reg-form').reset(); // Optionally reset the form
  });
});
</script>
</body>
</html>